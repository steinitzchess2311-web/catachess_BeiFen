# Blog API æ¥å£æ–‡æ¡£

## ğŸ“‹ API ç«¯ç‚¹æ€»è§ˆ

### å…¬å¼€æ¥å£ï¼ˆæ— éœ€è®¤è¯ï¼‰

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½ | ç¼“å­˜ | çŠ¶æ€ |
|------|------|------|------|------|
| GET | `/api/blogs/categories` | è·å–åˆ†ç±»åˆ—è¡¨ | 1å°æ—¶ | âœ… å·²å®ç° |
| GET | `/api/blogs/articles` | è·å–æ–‡ç« åˆ—è¡¨ï¼ˆåˆ†é¡µ+æœç´¢+ç­›é€‰ï¼‰ | 5åˆ†é’Ÿ | âœ… å·²å®ç° |
| GET | `/api/blogs/articles/pinned` | è·å–ç½®é¡¶æ–‡ç«  | 5åˆ†é’Ÿ | âœ… å·²å®ç° |
| GET | `/api/blogs/articles/{id}` | è·å–æ–‡ç« è¯¦æƒ… | 10åˆ†é’Ÿ | âœ… å·²å®ç° |
| GET | `/api/blogs/cache/stats` | æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ | - | âœ… å·²å®ç° |

### ç®¡ç†æ¥å£ï¼ˆéœ€è¦è®¤è¯ï¼‰

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½ | æƒé™è¦æ±‚ | çŠ¶æ€ |
|------|------|------|---------|------|
| GET | `/api/blogs/articles/my-drafts` | è·å–æˆ‘çš„è‰ç¨¿ | Editor/Admin | âœ… å·²å®ç° |
| POST | `/api/blogs/upload-image` | ä¸Šä¼ å›¾ç‰‡åˆ°R2 | Editor/Admin | âœ… å·²å®ç° |
| POST | `/api/blogs/articles` | åˆ›å»ºæ–‡ç«  | Editor/Admin | âœ… å·²å®ç° |
| PUT | `/api/blogs/articles/{id}` | æ›´æ–°æ–‡ç«  | ä½œè€…/Admin | âœ… å·²å®ç° |
| DELETE | `/api/blogs/articles/{id}` | åˆ é™¤æ–‡ç«  | ä½œè€…/Admin | âœ… å·²å®ç° |
| POST | `/api/blogs/articles/{id}/pin` | ç½®é¡¶/å–æ¶ˆç½®é¡¶ | Admin | âœ… å·²å®ç° |

---

## ğŸ“– å…¬å¼€æ¥å£è¯¦è§£

### 1. è·å–åˆ†ç±»åˆ—è¡¨
```
GET /api/blogs/categories
```

**åŠŸèƒ½ï¼š** è¿”å›æ‰€æœ‰æ´»è·ƒåˆ†ç±»åŠå…¶å…ƒæ•°æ®

**å‚æ•°ï¼š** æ— 

**è¿”å›ç¤ºä¾‹ï¼š**
```json
[
  {
    "id": "uuid",
    "name": "about",
    "display_name": "About Us",
    "description": "Learn about Chessortag platform",
    "icon": "ğŸ“–",
    "order_index": 1,
    "is_active": true,
    "created_at": "2026-02-09T19:58:46.490453"
  }
]
```

**ç¼“å­˜ç­–ç•¥ï¼š** Redis 1å°æ—¶

---

### 2. è·å–æ–‡ç« åˆ—è¡¨
```
GET /api/blogs/articles
```

**åŠŸèƒ½ï¼š** åˆ†é¡µè·å–å·²å‘å¸ƒæ–‡ç« ï¼Œæ”¯æŒåˆ†ç±»ç­›é€‰å’Œå…¨æ–‡æœç´¢

**æŸ¥è¯¢å‚æ•°ï¼š**
- `category` (å¯é€‰): åˆ†ç±»ç­›é€‰ (about/function/allblogs/user)
- `search` (å¯é€‰): å…¨æ–‡æœç´¢å…³é”®è¯ï¼ˆæœç´¢æ ‡é¢˜+å†…å®¹ï¼‰
- `page` (é»˜è®¤1): é¡µç ï¼Œä»1å¼€å§‹
- `page_size` (é»˜è®¤10): æ¯é¡µæ•°é‡ï¼Œæœ€å¤§50

**æ’åºè§„åˆ™ï¼š**
1. ç½®é¡¶æ–‡ç« ä¼˜å…ˆï¼ˆis_pinned=trueï¼‰
2. æŒ‰pin_orderå€’åºï¼ˆç½®é¡¶æ–‡ç« ä¹‹é—´ï¼‰
3. æŒ‰published_atå€’åºï¼ˆå‘å¸ƒæ—¶é—´ï¼‰

**è¿”å›ç¤ºä¾‹ï¼š**
```json
{
  "items": [
    {
      "id": "uuid",
      "title": "æ–‡ç« æ ‡é¢˜",
      "subtitle": "å‰¯æ ‡é¢˜",
      "cover_image_url": "https://cdn.example.com/image.jpg",
      "author_name": "ä½œè€…å",
      "author_type": "official",
      "category": "function",
      "tags": ["æ•™ç¨‹", "æ–°æ‰‹"],
      "is_pinned": false,
      "view_count": 1234,
      "like_count": 56,
      "comment_count": 12,
      "created_at": "2026-02-09T10:00:00Z",
      "published_at": "2026-02-09T10:00:00Z"
    }
  ],
  "total": 25,
  "page": 1,
  "page_size": 10,
  "total_pages": 3,
  "has_next": true,
  "has_prev": false
}
```

**ç¼“å­˜ç­–ç•¥ï¼š**
- æœ‰searchå‚æ•°ï¼šä¸ç¼“å­˜ï¼ˆå®æ—¶æŸ¥è¯¢ï¼‰
- æ— searchå‚æ•°ï¼šRedis 5åˆ†é’Ÿ

**ç¤ºä¾‹è¯·æ±‚ï¼š**
```bash
# è·å–æ‰€æœ‰æ–‡ç« ï¼Œç¬¬1é¡µ
GET /api/blogs/articles?page=1&page_size=10

# æŒ‰åˆ†ç±»ç­›é€‰
GET /api/blogs/articles?category=function&page=1

# æœç´¢æ–‡ç« 
GET /api/blogs/articles?search=å›½é™…è±¡æ£‹&page=1
```

---

### 3. è·å–ç½®é¡¶æ–‡ç« 
```
GET /api/blogs/articles/pinned
```

**åŠŸèƒ½ï¼š** è¿”å›æ‰€æœ‰ç½®é¡¶æ–‡ç« 

**å‚æ•°ï¼š** æ— 

**æ’åºè§„åˆ™ï¼š**
1. æŒ‰pin_orderå€’åºï¼ˆæ•°å­—å¤§çš„åœ¨å‰ï¼‰
2. æŒ‰published_atå€’åº

**è¿”å›ï¼š** æ–‡ç« åˆ—è¡¨ï¼ˆæ ¼å¼åŒä¸Šï¼Œä¸å«contentå­—æ®µï¼‰

**ç¼“å­˜ç­–ç•¥ï¼š** Redis 5åˆ†é’Ÿ

---

### 4. è·å–æ–‡ç« è¯¦æƒ…
```
GET /api/blogs/articles/{id}
```

**åŠŸèƒ½ï¼š** è·å–å•ç¯‡æ–‡ç« çš„å®Œæ•´å†…å®¹

**è·¯å¾„å‚æ•°ï¼š**
- `id`: æ–‡ç« UUID

**å‰¯ä½œç”¨ï¼š**
- è‡ªåŠ¨å¢åŠ æµè§ˆè®¡æ•°ï¼ˆview_count + 1ï¼‰
- æµè§ˆè®¡æ•°å¼‚æ­¥æ›´æ–°ï¼Œä¸å½±å“å“åº”é€Ÿåº¦

**è¿”å›ç¤ºä¾‹ï¼š**
```json
{
  "id": "uuid",
  "title": "æ–‡ç« æ ‡é¢˜",
  "subtitle": "å‰¯æ ‡é¢˜",
  "content": "# Markdownå†…å®¹\n\nè¿™æ˜¯æ–‡ç« æ­£æ–‡...",
  "cover_image_url": "https://cdn.example.com/cover.jpg",
  "author_id": "uuid",
  "author_name": "ä½œè€…å",
  "author_type": "official",
  "category": "function",
  "sub_category": "tutorial",
  "tags": ["æ•™ç¨‹", "æ–°æ‰‹"],
  "status": "published",
  "is_pinned": false,
  "pin_order": 0,
  "view_count": 1235,
  "like_count": 56,
  "comment_count": 12,
  "created_at": "2026-02-09T10:00:00Z",
  "updated_at": "2026-02-09T11:00:00Z",
  "published_at": "2026-02-09T10:00:00Z"
}
```

**é”™è¯¯å“åº”ï¼š**
- 404: æ–‡ç« ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ

**ç¼“å­˜ç­–ç•¥ï¼š** Redis 10åˆ†é’Ÿ

---

### 5. æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ï¼ˆè°ƒè¯•ç”¨ï¼‰
```
GET /api/blogs/cache/stats
```

**åŠŸèƒ½ï¼š** æŸ¥çœ‹Redisç¼“å­˜å‘½ä¸­ç‡å’Œç»Ÿè®¡ä¿¡æ¯

**è¿”å›ç¤ºä¾‹ï¼š**
```json
{
  "connected": true,
  "hit_rate": 54.55,
  "total_hits": 120,
  "total_misses": 100,
  "keys_count": 25
}
```

---

## âœï¸ ç®¡ç†æ¥å£è¯¦è§£

### 6. è·å–æˆ‘çš„è‰ç¨¿
```
GET /api/blogs/articles/my-drafts
```

**åŠŸèƒ½ï¼š** è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰è‰ç¨¿æ–‡ç« 

**è®¤è¯ï¼š** éœ€è¦Editoræˆ–Adminè§’è‰²

**æƒé™ï¼š** åªèƒ½æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„è‰ç¨¿

**æ’åºï¼š** æŒ‰updated_atå€’åºï¼ˆæœ€è¿‘ç¼–è¾‘çš„åœ¨å‰ï¼‰

**è¿”å›ï¼š** æ–‡ç« åˆ—è¡¨ï¼ˆæ ¼å¼åŒ"è·å–æ–‡ç« åˆ—è¡¨"ï¼Œä¸å«contentå­—æ®µï¼‰

**ç¼“å­˜ç­–ç•¥ï¼š** ä¸ç¼“å­˜ï¼ˆå®æ—¶æŸ¥è¯¢ï¼‰

---

### 7. ä¸Šä¼ å›¾ç‰‡
```
POST /api/blogs/upload-image
```

**åŠŸèƒ½ï¼š** ä¸Šä¼ å›¾ç‰‡åˆ°Cloudflare R2å­˜å‚¨

**è®¤è¯ï¼š** éœ€è¦Editoræˆ–Adminè§’è‰²

**è¯·æ±‚æ ¼å¼ï¼š** multipart/form-data

**å‚æ•°ï¼š**
- `file` (å¿…éœ€): å›¾ç‰‡æ–‡ä»¶ï¼Œæœ€å¤§5MB
- `resize_mode` (é»˜è®¤adaptive_width): å¤„ç†æ¨¡å¼
  - `original`: ä¿æŒåŸå§‹å°ºå¯¸ï¼Œè½»åº¦å‹ç¼©ï¼ˆ90%è´¨é‡ï¼‰
  - `adaptive_width`: è‡ªé€‚åº”å®½åº¦ï¼Œæœ€å¤§1920pxï¼ŒWebPæ ¼å¼ï¼ˆ85%è´¨é‡ï¼‰
- `image_type` (é»˜è®¤content): å›¾ç‰‡ç±»å‹
  - `cover`: å°é¢å›¾
  - `content`: å†…å®¹å›¾

**æ”¯æŒæ ¼å¼ï¼š** JPEG, PNG, GIF, WEBP

**å¤„ç†é€»è¾‘ï¼š**
1. éªŒè¯æ–‡ä»¶å¤§å°å’Œæ ¼å¼
2. æ ¹æ®resize_modeå¤„ç†å›¾ç‰‡
3. ä¸Šä¼ åˆ°R2å­˜å‚¨ï¼ˆè·¯å¾„ï¼š`blog/å¹´/æœˆ/å”¯ä¸€ID_æ–‡ä»¶å`ï¼‰
4. ä¿å­˜å…ƒæ•°æ®åˆ°PostgreSQLï¼ˆblog_imagesè¡¨ï¼‰

**è¿”å›ç¤ºä¾‹ï¼š**
```json
{
  "id": "uuid",
  "url": "https://cdn.example.com/blog/2026/02/abc123_image.webp",
  "filename": "image.webp",
  "size_bytes": 245678,
  "width": 1920,
  "height": 1080,
  "resize_mode": "adaptive_width",
  "image_type": "content"
}
```

**é”™è¯¯å“åº”ï¼š**
- 400: æ–‡ä»¶å¤§å°è¶…é™æˆ–æ ¼å¼ä¸æ”¯æŒ
- 500: ä¸Šä¼ å¤±è´¥

---

### 8. åˆ›å»ºæ–‡ç« 
```
POST /api/blogs/articles
```

**åŠŸèƒ½ï¼š** åˆ›å»ºæ–°æ–‡ç« ï¼ˆè‰ç¨¿æˆ–ç›´æ¥å‘å¸ƒï¼‰

**è®¤è¯ï¼š** éœ€è¦Editoræˆ–Adminè§’è‰²

**è¯·æ±‚ä½“ç¤ºä¾‹ï¼š**
```json
{
  "title": "æ–‡ç« æ ‡é¢˜",
  "subtitle": "å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰",
  "content": "# Markdownå†…å®¹\n\næ–‡ç« æ­£æ–‡...",
  "cover_image_url": "https://cdn.example.com/cover.jpg",
  "author_name": "ä½œè€…å",
  "author_type": "official",
  "category": "function",
  "sub_category": "tutorial",
  "tags": ["æ•™ç¨‹", "æ–°æ‰‹"],
  "status": "draft",
  "is_pinned": false,
  "pin_order": 0
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `title` (å¿…éœ€): æ ‡é¢˜
- `content` (å¿…éœ€): Markdownæ ¼å¼å†…å®¹
- `category` (å¿…éœ€): åˆ†ç±»åï¼ˆabout/function/allblogs/userï¼‰
- `status` (é»˜è®¤draft): çŠ¶æ€
  - `draft`: è‰ç¨¿ï¼ˆä¸å…¬å¼€ï¼‰
  - `published`: å‘å¸ƒï¼ˆå…¬å¼€ï¼‰
  - `archived`: å½’æ¡£ï¼ˆä¸å…¬å¼€ï¼‰
- `author_type: officialï¼ˆå®˜æ–¹ï¼‰æˆ– userï¼ˆç”¨æˆ·æŠ•ç¨¿ï¼‰
- å…¶ä»–å­—æ®µå¯é€‰

**è‡ªåŠ¨å¤„ç†ï¼š**
- è‡ªåŠ¨è®¾ç½®author_idä¸ºå½“å‰ç”¨æˆ·
- status=publishedæ—¶ï¼Œè‡ªåŠ¨è®¾ç½®published_at
- åˆå§‹åŒ–è®¡æ•°å™¨ï¼ˆview_countã€like_countç­‰ï¼‰ä¸º0

**è¿”å›ï¼š** å®Œæ•´æ–‡ç« å¯¹è±¡

**ç¼“å­˜å¤±æ•ˆï¼š** è‡ªåŠ¨æ¸…é™¤ç›¸å…³åˆ†ç±»å’Œæ€»åˆ—è¡¨ç¼“å­˜

---

### 9. æ›´æ–°æ–‡ç« 
```
PUT /api/blogs/articles/{id}
```

**åŠŸèƒ½ï¼š** æ›´æ–°ç°æœ‰æ–‡ç« 

**è®¤è¯ï¼š** éœ€è¦Editoræˆ–Adminè§’è‰²

**æƒé™æ£€æŸ¥ï¼š**
- âœ… ç”¨æˆ·å¯ä»¥ç¼–è¾‘**è‡ªå·±çš„**æ–‡ç« 
- âœ… Adminå¯ä»¥ç¼–è¾‘**ä»»ä½•**æ–‡ç« 
- âŒ ç”¨æˆ·ä¸èƒ½ç¼–è¾‘ä»–äººçš„æ–‡ç« 

**è·¯å¾„å‚æ•°ï¼š**
- `id`: æ–‡ç« UUID

**è¯·æ±‚ä½“ï¼š** éƒ¨åˆ†æ›´æ–°ï¼ˆåªéœ€æä¾›è¦ä¿®æ”¹çš„å­—æ®µï¼‰
```json
{
  "title": "æ–°æ ‡é¢˜",
  "content": "æ›´æ–°åçš„å†…å®¹",
  "status": "published"
}
```

**è‡ªåŠ¨å¤„ç†ï¼š**
- è‡ªåŠ¨æ›´æ–°updated_atæ—¶é—´æˆ³
- statusä»draftæ”¹ä¸ºpublishedæ—¶ï¼Œè‡ªåŠ¨è®¾ç½®published_at

**è¿”å›ï¼š** æ›´æ–°åçš„å®Œæ•´æ–‡ç« å¯¹è±¡

**é”™è¯¯å“åº”ï¼š**
- 403: æƒé™ä¸è¶³ï¼ˆä¸èƒ½ç¼–è¾‘ä»–äººæ–‡ç« ï¼‰
- 404: æ–‡ç« ä¸å­˜åœ¨

**ç¼“å­˜å¤±æ•ˆï¼š** è‡ªåŠ¨æ¸…é™¤æ–‡ç« è¯¦æƒ…ã€ç›¸å…³åˆ†ç±»å’Œæ€»åˆ—è¡¨ç¼“å­˜

---

### 10. åˆ é™¤æ–‡ç« 
```
DELETE /api/blogs/articles/{id}
```

**åŠŸèƒ½ï¼š** åˆ é™¤æ–‡ç« ï¼ˆç¡¬åˆ é™¤ï¼‰

**è®¤è¯ï¼š** éœ€è¦Editoræˆ–Adminè§’è‰²

**æƒé™æ£€æŸ¥ï¼š**
- âœ… ç”¨æˆ·å¯ä»¥åˆ é™¤**è‡ªå·±çš„**æ–‡ç« 
- âœ… Adminå¯ä»¥åˆ é™¤**ä»»ä½•**æ–‡ç« 
- âŒ ç”¨æˆ·ä¸èƒ½åˆ é™¤ä»–äººçš„æ–‡ç« 

**è·¯å¾„å‚æ•°ï¼š**
- `id`: æ–‡ç« UUID

**åˆ é™¤è¡Œä¸ºï¼š**
- ç¡¬åˆ é™¤ï¼ˆä»æ•°æ®åº“ä¸­æ°¸ä¹…åˆ é™¤ï¼‰
- ç›¸å…³å›¾ç‰‡çš„article_idè®¾ç½®ä¸ºNULLï¼ˆå›¾ç‰‡ä¸åˆ é™¤ï¼‰

**è¿”å›ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "Article deleted successfully"
}
```

**é”™è¯¯å“åº”ï¼š**
- 403: æƒé™ä¸è¶³ï¼ˆä¸èƒ½åˆ é™¤ä»–äººæ–‡ç« ï¼‰
- 404: æ–‡ç« ä¸å­˜åœ¨

**ç¼“å­˜å¤±æ•ˆï¼š** è‡ªåŠ¨æ¸…é™¤æ–‡ç« è¯¦æƒ…ã€ç›¸å…³åˆ†ç±»å’Œæ€»åˆ—è¡¨ç¼“å­˜

---

### 11. ç½®é¡¶/å–æ¶ˆç½®é¡¶æ–‡ç« 
```
POST /api/blogs/articles/{id}/pin
```

**åŠŸèƒ½ï¼š** è®¾ç½®æ–‡ç« ç½®é¡¶ä¼˜å…ˆçº§

**è®¤è¯ï¼š** éœ€è¦Adminè§’è‰²ï¼ˆä»…ç®¡ç†å‘˜å¯æ“ä½œï¼‰

**è·¯å¾„å‚æ•°ï¼š**
- `id`: æ–‡ç« UUID

**æŸ¥è¯¢å‚æ•°ï¼š**
- `pin_order` (é»˜è®¤0): ç½®é¡¶ä¼˜å…ˆçº§
  - 0: å–æ¶ˆç½®é¡¶
  - >0: è®¾ç½®ç½®é¡¶ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜

**ç¤ºä¾‹ï¼š**
```bash
# ç½®é¡¶æ–‡ç« ï¼Œä¼˜å…ˆçº§10
POST /api/blogs/articles/{id}/pin?pin_order=10

# å–æ¶ˆç½®é¡¶
POST /api/blogs/articles/{id}/pin?pin_order=0
```

**è¿”å›ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "Article pinned with order 10",
  "is_pinned": true,
  "pin_order": 10
}
```

**é”™è¯¯å“åº”ï¼š**
- 403: æƒé™ä¸è¶³ï¼ˆéœ€è¦Adminè§’è‰²ï¼‰
- 404: æ–‡ç« ä¸å­˜åœ¨

**ç¼“å­˜å¤±æ•ˆï¼š** è‡ªåŠ¨æ¸…é™¤æ–‡ç« è¯¦æƒ…ã€ç›¸å…³åˆ†ç±»ã€æ€»åˆ—è¡¨å’Œç½®é¡¶åˆ—è¡¨ç¼“å­˜

---

## ğŸ” è®¤è¯ä¸æƒé™

### è®¤è¯æ–¹å¼
```
Authorization: Bearer <JWT_TOKEN>
```

### æƒé™çº§åˆ«

| è§’è‰² | æƒé™è¯´æ˜ |
|------|---------|
| **æ¸¸å®¢ï¼ˆæœªç™»å½•ï¼‰** | æŸ¥çœ‹å·²å‘å¸ƒæ–‡ç« ã€åˆ†ç±» |
| **Editorï¼ˆç¼–è¾‘ï¼‰** | åˆ›å»º/ç¼–è¾‘/åˆ é™¤**è‡ªå·±çš„**æ–‡ç« ã€ä¸Šä¼ å›¾ç‰‡ã€æŸ¥çœ‹è‡ªå·±çš„è‰ç¨¿ |
| **Adminï¼ˆç®¡ç†å‘˜ï¼‰** | æ‰€æœ‰Editoræƒé™ + ç¼–è¾‘/åˆ é™¤**ä»»ä½•**æ–‡ç«  + ç½®é¡¶æ–‡ç«  |

### å¼€å‘æ¨¡å¼
è®¾ç½®ç¯å¢ƒå˜é‡ `BLOG_DEV_MODE=true` å¯ç»•è¿‡è®¤è¯ï¼ˆä»…ç”¨äºå¼€å‘æµ‹è¯•ï¼‰

---

## ğŸ’¾ æ•°æ®åº“ä¸ç¼“å­˜

### æ•°æ®è¡¨

| è¡¨å | ç”¨é€” |
|------|------|
| `blog_articles` | æ–‡ç« ä¸»è¡¨ |
| `blog_categories` | åˆ†ç±»è¡¨ |
| `blog_images` | å›¾ç‰‡å…ƒæ•°æ® |

### ç¼“å­˜ç­–ç•¥

| æ•°æ®ç±»å‹ | TTL | é”®æ ¼å¼ |
|---------|-----|--------|
| åˆ†ç±»åˆ—è¡¨ | 1å°æ—¶ | `blog:categories` |
| æ–‡ç« åˆ—è¡¨ | 5åˆ†é’Ÿ | `blog:articles:{category}:{page}` |
| ç½®é¡¶æ–‡ç«  | 5åˆ†é’Ÿ | `blog:pinned` |
| æ–‡ç« è¯¦æƒ… | 10åˆ†é’Ÿ | `blog:article:{id}` |
| æµè§ˆè®¡æ•° | å®æ—¶ | `blog:views:{id}` |

### ç¼“å­˜å¤±æ•ˆè§„åˆ™

| æ“ä½œ | å¤±æ•ˆèŒƒå›´ |
|------|---------|
| åˆ›å»ºæ–‡ç«  | ç›¸å…³åˆ†ç±»åˆ—è¡¨ã€æ€»åˆ—è¡¨ã€åˆ†ç±»ç»Ÿè®¡ |
| æ›´æ–°æ–‡ç«  | æ–‡ç« è¯¦æƒ…ã€ç›¸å…³åˆ†ç±»åˆ—è¡¨ã€æ€»åˆ—è¡¨ |
| åˆ é™¤æ–‡ç«  | æ–‡ç« è¯¦æƒ…ã€ç›¸å…³åˆ†ç±»åˆ—è¡¨ã€æ€»åˆ—è¡¨ |
| ç½®é¡¶æ–‡ç«  | æ–‡ç« è¯¦æƒ…ã€ç›¸å…³åˆ†ç±»åˆ—è¡¨ã€æ€»åˆ—è¡¨ã€ç½®é¡¶åˆ—è¡¨ |

---

## ğŸš€ è‰ç¨¿ç®¡ç†å·¥ä½œæµ

### å®Œæ•´æµç¨‹ç¤ºä¾‹

```bash
# 1. åˆ›å»ºè‰ç¨¿
POST /api/blogs/articles
{
  "title": "æˆ‘çš„æ–°æ–‡ç« ",
  "content": "è‰ç¨¿å†…å®¹...",
  "status": "draft",
  "category": "function"
}
# è¿”å›: { "id": "article-uuid", ... }

# 2. æŸ¥çœ‹æˆ‘çš„è‰ç¨¿åˆ—è¡¨
GET /api/blogs/articles/my-drafts
# è¿”å›: [{ "id": "article-uuid", "title": "æˆ‘çš„æ–°æ–‡ç« ", ... }]

# 3. ç¼–è¾‘è‰ç¨¿
PUT /api/blogs/articles/{article-uuid}
{
  "title": "æ›´æ–°åçš„æ ‡é¢˜",
  "content": "æ›´æ–°åçš„å†…å®¹"
}

# 4. å‘å¸ƒè‰ç¨¿
PUT /api/blogs/articles/{article-uuid}
{
  "status": "published"
}

# 5. ï¼ˆå¯é€‰ï¼‰åˆ é™¤æ–‡ç« 
DELETE /api/blogs/articles/{article-uuid}
```

### å‰ç«¯é›†æˆå»ºè®®

**æ··åˆå­˜å‚¨ç­–ç•¥ï¼š**
1. **localStorageè‡ªåŠ¨ä¿å­˜**ï¼šæ¯30ç§’ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ï¼ˆé˜²æ„å¤–å…³é—­ï¼‰
2. **æ‰‹åŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨**ï¼šç”¨æˆ·ç‚¹å‡»"ä¿å­˜è‰ç¨¿"æŒ‰é’®æ—¶ä¿å­˜åˆ°æ•°æ®åº“
3. **å†²çªæ£€æµ‹**ï¼šé¡µé¢åŠ è½½æ—¶ï¼Œæ¯”è¾ƒlocalStorageå’ŒæœåŠ¡å™¨æ—¶é—´æˆ³ï¼Œæç¤ºç”¨æˆ·é€‰æ‹©

è¯¦ç»†å‰ç«¯é›†æˆä»£ç è¯·å‚è€ƒï¼š`DRAFT_API.md`

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å“åº”æ—¶é—´ï¼ˆ90th percentileï¼‰

| ç«¯ç‚¹ç±»å‹ | ç¼“å­˜å‘½ä¸­ | ç¼“å­˜æœªå‘½ä¸­ |
|---------|---------|-----------|
| æ–‡ç« åˆ—è¡¨ | <50ms | <200ms |
| æ–‡ç« è¯¦æƒ… | <30ms | <150ms |
| åˆ†ç±»åˆ—è¡¨ | <20ms | <100ms |
| å›¾ç‰‡ä¸Šä¼  | - | <2000ms |

### å®¹é‡è§„åˆ’

- **å¹¶å‘è¯·æ±‚**ï¼šæ”¯æŒ1000+ QPSï¼ˆ4 workerè¿›ç¨‹ï¼‰
- **æ•°æ®åº“è¿æ¥æ± **ï¼š60è¿æ¥ï¼ˆæ¯worker 15è¿æ¥ï¼‰
- **Redisè¿æ¥**ï¼šæ¯worker 1ä¸ªå¼‚æ­¥è¿æ¥
- **æ–‡ä»¶ä¸Šä¼ **ï¼šæœ€å¤§5MB/è¯·æ±‚

---

## ğŸ”„ é”™è¯¯ç è¯´æ˜

| çŠ¶æ€ç  | è¯´æ˜ | å¸¸è§åŸå›  |
|--------|------|---------|
| 200 | æˆåŠŸ | - |
| 400 | è¯·æ±‚é”™è¯¯ | å‚æ•°éªŒè¯å¤±è´¥ã€æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ |
| 401 | æœªè®¤è¯ | ç¼ºå°‘Authorizationå¤´æˆ–tokenæ— æ•ˆ |
| 403 | æƒé™ä¸è¶³ | å°è¯•ç¼–è¾‘ä»–äººæ–‡ç« ã€éAdminå°è¯•ç½®é¡¶ |
| 404 | èµ„æºä¸å­˜åœ¨ | æ–‡ç« ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ |
| 422 | å‚æ•°éªŒè¯å¤±è´¥ | å­—æ®µç±»å‹é”™è¯¯ã€UUIDæ ¼å¼é”™è¯¯ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | æ•°æ®åº“è¿æ¥å¤±è´¥ã€R2ä¸Šä¼ å¤±è´¥ |

---

## ğŸ“ çŠ¶æ€å­—æ®µè¯´æ˜

### article.status

| å€¼ | è¯´æ˜ | å…¬å¼€å¯è§ |
|----|------|---------|
| `draft` | è‰ç¨¿ | âŒ ä»…ä½œè€…å’ŒAdminå¯è§ |
| `published` | å·²å‘å¸ƒ | âœ… æ‰€æœ‰äººå¯è§ |
| `archived` | å·²å½’æ¡£ | âŒ ä»…ä½œè€…å’ŒAdminå¯è§ |

### article.author_type

| å€¼ | è¯´æ˜ |
|----|------|
| `official` | å®˜æ–¹æ–‡ç« ï¼ˆç®¡ç†å‘˜/ç¼–è¾‘å‘å¸ƒï¼‰ |
| `user` | ç”¨æˆ·æŠ•ç¨¿ |

---

## ğŸ¯ MVPå®æ–½çŠ¶æ€

### âœ… ç¬¬ä¸€é˜¶æ®µï¼ˆå·²å®Œæˆï¼‰
- [x] æ•°æ®åº“è¡¨è®¾è®¡ä¸è¿ç§»
- [x] Redisç¼“å­˜æœåŠ¡
- [x] æ–‡ç« æŸ¥è¯¢æ¥å£ï¼ˆåˆ—è¡¨ã€è¯¦æƒ…ã€åˆ†ç±»ï¼‰
- [x] å›¾ç‰‡ä¸Šä¼ åˆ°R2
- [x] æ–‡ç« ç®¡ç†æ¥å£ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ï¼‰

### âœ… ç¬¬äºŒé˜¶æ®µï¼ˆå·²å®Œæˆï¼‰
- [x] ç½®é¡¶æ–‡ç« åŠŸèƒ½
- [x] å…¨æ–‡æœç´¢ï¼ˆtitle + content ILIKEï¼‰
- [x] è‰ç¨¿ç®¡ç†ç³»ç»Ÿ
- [x] ä½œè€…æƒé™æ§åˆ¶

### ğŸ”œ ç¬¬ä¸‰é˜¶æ®µï¼ˆè§„åˆ’ä¸­ï¼‰
- [ ] ç”¨æˆ·å‘å¸ƒåšå®¢
- [ ] ç‚¹èµåŠŸèƒ½
- [ ] è¯„è®ºç³»ç»Ÿ
- [ ] PostgreSQLå…¨æ–‡æœç´¢ï¼ˆGINç´¢å¼•ï¼‰

---

**Base URL:** `https://api.catachess.com`

---

## ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†ç³»ç»Ÿ

### æ¶æ„è®¾è®¡

Blogæ¨¡å—ä½¿ç”¨**å¤šå¯¹å¤šå…³è”è¡¨**æ¥ç®¡ç†æ–‡ç« å’Œå›¾ç‰‡çš„å…³ç³»ï¼Œæ”¯æŒå›¾ç‰‡å¤ç”¨å’Œæ™ºèƒ½æ¸…ç†ã€‚

#### æ•°æ®åº“è¡¨

```sql
-- å›¾ç‰‡å…ƒæ•°æ®è¡¨
blog_images
â”œâ”€â”€ id (UUID)
â”œâ”€â”€ url (CDN URL)
â”œâ”€â”€ storage_path (R2è·¯å¾„)
â”œâ”€â”€ uploaded_by (ä¸Šä¼ è€…)
â”œâ”€â”€ is_orphan (æ˜¯å¦å­¤å„¿å›¾ç‰‡)
â”œâ”€â”€ marked_for_deletion_at (æ ‡è®°åˆ é™¤æ—¶é—´)
â”œâ”€â”€ last_referenced_at (æœ€åå¼•ç”¨æ—¶é—´)
â””â”€â”€ ...

-- æ–‡ç« -å›¾ç‰‡å…³è”è¡¨ (å¤šå¯¹å¤š)
blog_article_images
â”œâ”€â”€ id (UUID)
â”œâ”€â”€ article_id (æ–‡ç« ID)
â”œâ”€â”€ image_id (å›¾ç‰‡ID)
â”œâ”€â”€ position (å›¾ç‰‡ä½ç½®)
â”œâ”€â”€ usage_context ("content" | "cover")
â””â”€â”€ created_at
```

### å›¾ç‰‡å·¥ä½œæµç¨‹

#### 1. ä¸Šä¼ å›¾ç‰‡

```bash
POST /api/blogs/upload-image
Content-Type: multipart/form-data

file: <image_file>
resize_mode: "adaptive_width"  # æˆ– "original"
image_type: "content"          # æˆ– "cover"
```

**å¤„ç†æµç¨‹ï¼š**
1. éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§5MBï¼‰å’Œæ ¼å¼ï¼ˆJPEG/PNG/GIF/WEBPï¼‰
2. æ ¹æ®`resize_mode`å¤„ç†å›¾ç‰‡ï¼š
   - `adaptive_width`: æœ€å¤§å®½åº¦1920pxï¼Œè½¬WebPæ ¼å¼ï¼ˆ85%è´¨é‡ï¼‰
   - `original`: ä¿æŒåŸå§‹å°ºå¯¸ï¼Œè½»åº¦å‹ç¼©ï¼ˆ90%è´¨é‡ï¼‰
3. ä¸Šä¼ åˆ°Cloudflare R2ï¼š`blog/å¹´/æœˆ/å”¯ä¸€ID_æ–‡ä»¶å`
4. ä¿å­˜å…ƒæ•°æ®åˆ°`blog_images`è¡¨ï¼ˆ`is_orphan=true`ï¼‰

**è¿”å›ï¼š**
```json
{
  "id": "uuid",
  "url": "https://cdn.catachess.com/blog/2026/02/abc123_image.webp",
  "markdown": "![image](https://cdn.catachess.com/blog/2026/02/abc123_image.webp)"
}
```

**å‰ç«¯ä½¿ç”¨ï¼š**
- ç”¨æˆ·åœ¨Markdownç¼–è¾‘å™¨ä¸­ç²˜è´´/æ‹–æ‹½å›¾ç‰‡
- å‰ç«¯è‡ªåŠ¨è°ƒç”¨ä¸Šä¼ æ¥å£
- è·å¾—`markdown`å­—æ®µåï¼Œè‡ªåŠ¨æ’å…¥åˆ°å…‰æ ‡ä½ç½®

---

#### 2. åˆ›å»ºæ–‡ç« ï¼ˆè‡ªåŠ¨å…³è”å›¾ç‰‡ï¼‰

```bash
POST /api/blogs/articles
{
  "title": "æ–‡ç« æ ‡é¢˜",
  "content": "æ–‡å­— ![img1](https://cdn.../image1.webp) æ›´å¤šæ–‡å­— ![img2](https://cdn.../image2.webp)",
  "cover_image_url": "https://cdn.../cover.jpg",
  ...
}
```

**åç«¯è‡ªåŠ¨å¤„ç†ï¼š**
1. åˆ›å»ºæ–‡ç« è®°å½•
2. è§£æ`content`ä¸­çš„æ‰€æœ‰å›¾ç‰‡URLï¼ˆæ­£åˆ™åŒ¹é…`![...](url)`ï¼‰
3. æŸ¥æ‰¾å¯¹åº”çš„`blog_images`è®°å½•
4. åˆ›å»º`blog_article_images`å…³è”è®°å½•
5. æ›´æ–°å›¾ç‰‡çŠ¶æ€ï¼š
   - `is_orphan = false`
   - `last_referenced_at = NOW()`
   - `marked_for_deletion_at = NULL`ï¼ˆæ¸…é™¤åˆ é™¤æ ‡è®°ï¼‰

**æ—¥å¿—è¾“å‡ºï¼š**
```
âœ… Linked 3 images to new article
```

---

#### 3. æ›´æ–°æ–‡ç« ï¼ˆé‡æ–°åŒæ­¥å›¾ç‰‡ï¼‰

```bash
PUT /api/blogs/articles/{id}
{
  "content": "æ›´æ–°åçš„å†…å®¹ï¼Œå¯èƒ½æ·»åŠ /åˆ é™¤äº†å›¾ç‰‡"
}
```

**æ™ºèƒ½åŒæ­¥é€»è¾‘ï¼š**
1. æå–æ–°çš„å›¾ç‰‡URLåˆ—è¡¨
2. å¯¹æ¯”å½“å‰å…³è”çš„å›¾ç‰‡ï¼š
   - **æ–°å¢çš„å›¾ç‰‡**ï¼šåˆ›å»ºå…³è”ï¼Œæ ‡è®°`is_orphan=false`
   - **ä¿ç•™çš„å›¾ç‰‡**ï¼šä¸å˜
   - **åˆ é™¤çš„å›¾ç‰‡**ï¼š
     - åˆ é™¤å…³è”è®°å½•
     - æ£€æŸ¥æ˜¯å¦è¢«å…¶ä»–æ–‡ç« ä½¿ç”¨
     - å¦‚æœæ²¡æœ‰å…¶ä»–å¼•ç”¨ï¼Œæ ‡è®°`is_orphan=true`

**æ—¥å¿—è¾“å‡ºï¼š**
```
âœ… Synced images: linked=2, unlinked=1
```

---

#### 4. åˆ é™¤æ–‡ç« ï¼ˆè‡ªåŠ¨æ¸…ç†å…³è”ï¼‰

```bash
DELETE /api/blogs/articles/{id}
```

**æ¸…ç†é€»è¾‘ï¼š**
1. åˆ é™¤æ–‡ç« è®°å½•ï¼ˆCASCADEè‡ªåŠ¨åˆ é™¤`blog_article_images`å…³è”ï¼‰
2. è§¦å‘å™¨/å®šæ—¶ä»»åŠ¡æ£€æŸ¥å­¤å„¿å›¾ç‰‡
3. å­¤å„¿å›¾ç‰‡è¿›å…¥æ¸…ç†æµç¨‹

---

### å­¤å„¿å›¾ç‰‡æ¸…ç†æœºåˆ¶

#### å®šä¹‰
**å­¤å„¿å›¾ç‰‡** = ä¸Šä¼ åæœªè¢«ä»»ä½•æ–‡ç« ä½¿ç”¨çš„å›¾ç‰‡

#### æ¸…ç†ç­–ç•¥ï¼ˆä¸¤é˜¶æ®µï¼‰

**é˜¶æ®µ1ï¼šæ ‡è®°å­¤å„¿**ï¼ˆæ¯å¤©è¿è¡Œï¼‰
- æ¡ä»¶ï¼š`is_orphan=true` ä¸” `created_at < 30å¤©å‰`
- åŠ¨ä½œï¼šè®¾ç½®`marked_for_deletion_at = NOW()`
- ç›®çš„ï¼šç»™ç”¨æˆ·7å¤©å®½é™æœŸ

**é˜¶æ®µ2ï¼šåˆ é™¤æ ‡è®°å›¾ç‰‡**ï¼ˆæ¯å¤©è¿è¡Œï¼‰
- æ¡ä»¶ï¼š`marked_for_deletion_at < 7å¤©å‰`
- åŠ¨ä½œï¼š
  1. ä»R2åˆ é™¤æ–‡ä»¶
  2. ä»æ•°æ®åº“åˆ é™¤è®°å½•

#### æ‰‹åŠ¨è¿è¡Œæ¸…ç†ä»»åŠ¡

```bash
# æ˜¾ç¤ºç»Ÿè®¡
python -m modules.blogs.tasks.cleanup_images stats

# æ ‡è®°å­¤å„¿å›¾ç‰‡
python -m modules.blogs.tasks.cleanup_images mark

# åˆ é™¤å·²æ ‡è®°çš„å›¾ç‰‡
python -m modules.blogs.tasks.cleanup_images delete

# å®Œæ•´æ¸…ç†æµç¨‹
python -m modules.blogs.tasks.cleanup_images all
```

#### å®šæ—¶ä»»åŠ¡ï¼ˆcronï¼‰

```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
0 2 * * * cd /app && python -m modules.blogs.tasks.cleanup_images all >> /var/log/blog_cleanup.log 2>&1
```

---

### å›¾ç‰‡å¤ç”¨

**åœºæ™¯ï¼š** åŒä¸€å¼ å›¾ç‰‡åœ¨å¤šç¯‡æ–‡ç« ä¸­ä½¿ç”¨

**å®ç°ï¼š**
- `blog_article_images` è¡¨æ”¯æŒä¸€å¼ å›¾ç‰‡å…³è”å¤šç¯‡æ–‡ç« 
- åˆ é™¤æ–‡ç« æ—¶ï¼Œåªåˆ é™¤å…³è”è®°å½•ï¼Œä¸åˆ é™¤å›¾ç‰‡æœ¬èº«
- åªæœ‰å½“æ‰€æœ‰å…³è”éƒ½åˆ é™¤åï¼Œå›¾ç‰‡æ‰æ ‡è®°ä¸ºå­¤å„¿

**ç¤ºä¾‹ï¼š**
```sql
-- å›¾ç‰‡ img-001 è¢«ä¸¤ç¯‡æ–‡ç« ä½¿ç”¨
blog_article_images
â”œâ”€â”€ (article-A, img-001, content)
â””â”€â”€ (article-B, img-001, content)

-- åˆ é™¤ article-A åï¼š
-- img-001 ä»ç„¶è¢« article-B ä½¿ç”¨ï¼Œis_orphan=false

-- åˆ é™¤ article-B åï¼š
-- img-001 æ²¡æœ‰ä»»ä½•å¼•ç”¨ï¼Œis_orphan=true
```

---

### Markdown å›¾ç‰‡æå–

**æ­£åˆ™è¡¨è¾¾å¼ï¼š**
```python
pattern = r'!\[.*?\]\((https?://[^\)]+)\)'
urls = re.findall(pattern, markdown_content)
```

**åŒ¹é…ç¤ºä¾‹ï¼š**
```markdown
![æè¿°](https://cdn.example.com/image.jpg)  âœ… åŒ¹é…
![](https://cdn.example.com/image.png)     âœ… åŒ¹é…
![å›¾ç‰‡](https://example.com/img.webp)      âœ… åŒ¹é…

<img src="...">                            âŒ ä¸åŒ¹é…ï¼ˆHTMLæ ‡ç­¾ï¼‰
[é“¾æ¥](https://...)                        âŒ ä¸åŒ¹é…ï¼ˆéå›¾ç‰‡ï¼‰
```

---

### å‰ç«¯é›†æˆæŒ‡å—

#### æ¨èç¼–è¾‘å™¨
- **Toast UI Editor** - Markdownä¸“ç”¨ï¼Œæ”¯æŒå›¾ç‰‡ä¸Šä¼ é’©å­
- **tiptap** - ç°ä»£åŒ–ï¼Œçµæ´»æ€§é«˜
- **react-markdown-editor-lite** - è½»é‡

#### é›†æˆç¤ºä¾‹ï¼ˆReact + Toast UI Editorï¼‰

```typescript
import Editor from '@toast-ui/react-editor';

function BlogEditor() {
  const editorRef = useRef<Editor>(null);

  const handleImageUpload = async (blob: Blob, callback: Function) => {
    // 1. ä¸Šä¼ å›¾ç‰‡åˆ°åç«¯
    const formData = new FormData();
    formData.append('file', blob);
    formData.append('resize_mode', 'adaptive_width');
    formData.append('image_type', 'content');

    const response = await fetch('/api/blogs/upload-image', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    });

    const result = await response.json();

    // 2. å›è°ƒæ’å…¥Markdown
    callback(result.url, 'image alt text');
  };

  return (
    <Editor
      ref={editorRef}
      initialValue="# å¼€å§‹å†™ä½œ..."
      hooks={{
        addImageBlobHook: handleImageUpload
      }}
    />
  );
}
```

#### ä¿å­˜æ–‡ç« 

```typescript
async function saveArticle() {
  const markdown = editorRef.current?.getInstance().getMarkdown();

  await fetch('/api/blogs/articles', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      title: 'æ–‡ç« æ ‡é¢˜',
      content: markdown,  // åŒ…å«å›¾ç‰‡çš„Markdown
      cover_image_url: coverUrl,
      category: 'function',
      status: 'published'
    })
  });

  // åç«¯è‡ªåŠ¨å…³è”å›¾ç‰‡ï¼Œæ— éœ€å‰ç«¯é¢å¤–æ“ä½œ
}
```

---

### å®‰å…¨æ€§è€ƒè™‘

#### 1. æ–‡ä»¶éªŒè¯
- æœ€å¤§å¤§å°ï¼š5MB
- å…è®¸æ ¼å¼ï¼šJPEG, PNG, GIF, WEBP
- MIMEç±»å‹æ£€æŸ¥ï¼šä½¿ç”¨PillowéªŒè¯çœŸå®æ ¼å¼

#### 2. è·¯å¾„å®‰å…¨
- ä½¿ç”¨UUIDç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
- æŒ‰å¹´/æœˆç»„ç»‡ç›®å½•ï¼š`blog/2026/02/abc123_image.webp`
- é˜²æ­¢è·¯å¾„éå†æ”»å‡»

#### 3. æƒé™æ§åˆ¶
- ä¸Šä¼ å›¾ç‰‡ï¼šéœ€è¦Editoræˆ–Adminè§’è‰²
- å›¾ç‰‡URLå…¬å¼€ï¼ˆCDNï¼‰ï¼Œä½†ä¸Šä¼ å—é™

#### 4. å­¤å„¿å›¾ç‰‡æ¸…ç†
- 30å¤©å®½é™æœŸï¼ˆé¿å…è¯¯åˆ ï¼‰
- 7å¤©åˆ é™¤ç¡®è®¤æœŸï¼ˆå¯æ¢å¤ï¼‰
- æ—¥å¿—è®°å½•æ‰€æœ‰åˆ é™¤æ“ä½œ

---

### æ€§èƒ½ä¼˜åŒ–

#### 1. å›¾ç‰‡å‹ç¼©
- `adaptive_width`æ¨¡å¼ï¼šè½¬WebPæ ¼å¼ï¼ˆèŠ‚çœ60%ä½“ç§¯ï¼‰
- æœ€å¤§å®½åº¦1920pxï¼ˆç§»åŠ¨ç«¯è‡ªé€‚åº”ï¼‰
- è´¨é‡85%ï¼ˆè§†è§‰æ— æŸï¼‰

#### 2. CDNç¼“å­˜
- Cache-Control: `public, max-age=31536000`ï¼ˆ1å¹´ï¼‰
- å›¾ç‰‡ä¸å¯å˜ï¼ˆæ–‡ä»¶ååŒ…å«UUIDï¼‰

#### 3. æ‰¹é‡æ“ä½œ
- å›¾ç‰‡å…³è”ï¼šå•æ¬¡æäº¤ï¼Œæ‰¹é‡INSERT
- æ¸…ç†ä»»åŠ¡ï¼šæ‰¹é‡æŸ¥è¯¢ï¼Œæ‰¹é‡åˆ é™¤

---

### ç›‘æ§ä¸ç»Ÿè®¡

#### æŸ¥çœ‹å­¤å„¿å›¾ç‰‡ç»Ÿè®¡

```bash
python -m modules.blogs.tasks.cleanup_images stats
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸ“Š Orphan Image Statistics:
  - Total orphan images: 45
  - Marked for deletion: 12
  - Total size: 23.5 MB
```

#### APIç«¯ç‚¹ï¼ˆæœªæ¥æ‰©å±•ï¼‰

```bash
# è·å–å­˜å‚¨ç»Ÿè®¡
GET /api/blogs/admin/storage-stats

# è¿”å›
{
  "total_images": 1234,
  "total_size_mb": 567.8,
  "orphan_count": 45,
  "orphan_size_mb": 23.5,
  "articles_with_images": 89
}
```

---

### æ•…éšœæ’æŸ¥

#### é—®é¢˜1ï¼šå›¾ç‰‡ä¸Šä¼ å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- R2é…ç½®é”™è¯¯ï¼šæ£€æŸ¥`R2_BLOG_ACCESS_KEY`, `R2_BLOG_SECRET_KEY`, `R2_ENDPOINT`
- æ–‡ä»¶å¤ªå¤§ï¼šæœ€å¤§5MB
- æ ¼å¼ä¸æ”¯æŒï¼šä»…æ”¯æŒJPEG/PNG/GIF/WEBP

**æ’æŸ¥ï¼š**
```bash
# æµ‹è¯•R2è¿æ¥
python -c "from modules.blogs.services.image_service import get_image_service; print(get_image_service())"
```

#### é—®é¢˜2ï¼šå›¾ç‰‡æœªå…³è”åˆ°æ–‡ç« 

**å¯èƒ½åŸå› ï¼š**
- Markdownæ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯`![...](url)`æ ¼å¼
- URLä¸åŒ¹é…ï¼šæ£€æŸ¥URLæ˜¯å¦å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬åè®®ã€åŸŸåï¼‰

**æ’æŸ¥ï¼š**
```python
from modules.blogs.utils.image_linker import extract_image_urls

content = "ä½ çš„Markdownå†…å®¹"
urls = extract_image_urls(content)
print(f"æå–åˆ°çš„URL: {urls}")
```

#### é—®é¢˜3ï¼šå­¤å„¿å›¾ç‰‡æœªæ¸…ç†

**å¯èƒ½åŸå› ï¼š**
- å®šæ—¶ä»»åŠ¡æœªè¿è¡Œï¼šæ£€æŸ¥croné…ç½®
- å®½é™æœŸæœªåˆ°ï¼šé»˜è®¤30å¤©+7å¤©=37å¤©

**æ’æŸ¥ï¼š**
```bash
# æ‰‹åŠ¨è¿è¡Œæ¸…ç†
python -m modules.blogs.tasks.cleanup_images all
```

---

## ğŸ“ æ€»ç»“

### æ–¹æ¡ˆBä¼˜åŠ¿

1. **å›¾ç‰‡å¤ç”¨** - ä¸€å¼ å›¾ç‰‡å¯ä»¥åœ¨å¤šç¯‡æ–‡ç« ä¸­ä½¿ç”¨
2. **æ™ºèƒ½æ¸…ç†** - è‡ªåŠ¨è¯†åˆ«å­¤å„¿å›¾ç‰‡ï¼Œåˆ†é˜¶æ®µåˆ é™¤
3. **æ•°æ®ä¸€è‡´æ€§** - å¤šå¯¹å¤šå…³è”è¡¨ï¼Œç¬¦åˆæ•°æ®åº“è§„èŒƒ
4. **æ€§èƒ½ä¼˜åŒ–** - å›¾ç‰‡å‹ç¼©+CDNç¼“å­˜
5. **å‰ç«¯å‹å¥½** - è‡ªåŠ¨å…³è”ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

### å¼€å‘checklist

- [x] åˆ›å»º`blog_article_images`å…³è”è¡¨
- [x] ä¿®æ”¹`blog_images`è¡¨ï¼ˆæ·»åŠ å­¤å„¿è¿½è¸ªå­—æ®µï¼‰
- [x] å®ç°å›¾ç‰‡URLæå–å·¥å…·
- [x] ä¿®æ”¹åˆ›å»º/æ›´æ–°æ–‡ç« APIï¼ˆè‡ªåŠ¨å…³è”å›¾ç‰‡ï¼‰
- [x] åˆ›å»ºå­¤å„¿å›¾ç‰‡æ¸…ç†ä»»åŠ¡
- [x] æ›´æ–°APIæ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬:** v2.0.0

**æœ€åæ›´æ–°:** 2026-02-10
