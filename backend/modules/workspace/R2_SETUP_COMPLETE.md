# âœ… R2 é…ç½®å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-11 15:30
**çŠ¶æ€**: é…ç½®æˆåŠŸå¹¶æµ‹è¯•é€šè¿‡ ğŸ‰

---

## é…ç½®ä¿¡æ¯

### è€æ¿æä¾›çš„èµ„æº
- **Endpoint**: `https://5f5a0298fe2da24a34b1fd0d3f795807.r2.cloudflarestorage.com`
- **Access Key**: `2e32a213937e6b75316c0d4ea8f4a6e1`
- **Secret Key**: `81b411967073f620788ad66c5118165b3f48f3363d88a558f0822cf0bc551f05`
- **Bucket**: `workspace`

### æµ‹è¯•ç»“æœ
```
âœ… R2 Client created successfully
   Endpoint: https://5f5a0298fe2da24a34b1fd0d3f795807.r2.cloudflarestorage.com
   Bucket: workspace
   Access Key: 2e32a213...

âœ… Successfully connected to bucket: workspace
   Bucket is empty (no objects yet)

ğŸ‰ R2 configuration is working perfectly!
```

---

## å·²å®Œæˆçš„å·¥ä½œ

### 1. âœ… æœ¬åœ°ç¯å¢ƒé…ç½®
**æ–‡ä»¶**: `/home/catadragon/Code/catachess/.env`

æ·»åŠ äº†ä»¥ä¸‹é…ç½®:
```bash
# ===== R2 Object Storage (Cloudflare R2) =====
R2_ENDPOINT=https://5f5a0298fe2da24a34b1fd0d3f795807.r2.cloudflarestorage.com
R2_ACCESS_KEY=2e32a213937e6b75316c0d4ea8f4a6e1
R2_SECRET_KEY=81b411967073f620788ad66c5118165b3f48f3363d88a558f0822cf0bc551f05
R2_BUCKET=workspace
```

### 2. âœ… æ–‡æ¡£ä¿®æ­£
**ä¿®æ­£çš„æ–‡ä»¶**:
- `backend/modules/workspace/README.md:149`
  - æ”¹æ­£å˜é‡å: `R2_BUCKET_NAME` â†’ `R2_BUCKET`
  - æ”¹æ­£ bucket å: `catachess-workspace` â†’ `workspace`

- `backend/modules/workspace/docs/phase1_progress.md:84`
  - æ”¹æ­£ bucket å: `catachess-games` â†’ `workspace`
  - æ·»åŠ æ›´æ–°æ—¥æœŸæ ‡è®°

### 3. âœ… æ·»åŠ è¯´æ˜æ–‡æ¡£
**æ–°å¢æ–‡ä»¶**:
- `backend/storage/STATUS.md`
  - è¯´æ˜ `backend/storage/` æ¨¡å—æš‚æœªå¯ç”¨
  - è§£é‡Šä¸¤ä¸ªæ¨¡å—çš„ç”¨é€”åŒºåˆ«
  - è®°å½•æ¶æ„å†³ç­–

- `backend/modules/workspace/R2_CONFIGURATION_FIX.md`
  - è¯¦ç»†è®°å½•é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ
  - æä¾›é…ç½®æ¸…å•

### 4. âœ… è¿æ¥æµ‹è¯•
æˆåŠŸæµ‹è¯• R2 bucket è¿æ¥å’Œè®¤è¯ï¼Œç¡®è®¤é…ç½®æ­£ç¡®ã€‚

---

## âš ï¸ éœ€è¦åœ¨ Railway éƒ¨ç½²ç¯å¢ƒé…ç½®

**æœ¬åœ°å¼€å‘ç¯å¢ƒå·²å®Œæˆï¼Œä½†ç”Ÿäº§ç¯å¢ƒ Railway è¿˜éœ€è¦é…ç½®ï¼**

### Railway ç¯å¢ƒå˜é‡é…ç½®æ­¥éª¤

1. ç™»å½• [Railway æ§åˆ¶å°](https://railway.app)
2. é€‰æ‹© `catachess` é¡¹ç›®
3. è¿›å…¥ **Variables** æ ‡ç­¾é¡µ
4. æ·»åŠ ä»¥ä¸‹ 4 ä¸ªç¯å¢ƒå˜é‡:

```bash
R2_ENDPOINT=https://5f5a0298fe2da24a34b1fd0d3f795807.r2.cloudflarestorage.com
R2_ACCESS_KEY=2e32a213937e6b75316c0d4ea8f4a6e1
R2_SECRET_KEY=81b411967073f620788ad66c5118165b3f48f3363d88a558f0822cf0bc551f05
R2_BUCKET=workspace
```

5. ç‚¹å‡»ä¿å­˜
6. Railway ä¼šè‡ªåŠ¨é‡å¯æœåŠ¡ä»¥åŠ è½½æ–°å˜é‡

---

## R2 Bucket ä½¿ç”¨è§„åˆ’

### Workspace Bucket å­˜å‚¨ç»“æ„
```
workspace/
â”œâ”€â”€ raw/                           # åŸå§‹å¯¼å…¥ PGNï¼ˆå¯é€‰ä¿ç•™ï¼‰
â”‚   â””â”€â”€ {upload_id}.pgn
â”œâ”€â”€ chapters/                      # æ ‡å‡†åŒ–ç« èŠ‚ PGN
â”‚   â””â”€â”€ {chapter_id}.pgn
â”œâ”€â”€ exports/                       # å¯¼å‡ºäº§ç‰©
â”‚   â”œâ”€â”€ {job_id}.pgn
â”‚   â””â”€â”€ {job_id}.zip
â””â”€â”€ snapshots/                     # ç‰ˆæœ¬å¿«ç…§
    â””â”€â”€ {study_id}/
        â””â”€â”€ {version}.json
```

### é¢„æœŸä½¿ç”¨åœºæ™¯
1. **PGN å¯¼å…¥**: ç”¨æˆ·å¯¼å…¥å¤§ PGN æ–‡ä»¶æ—¶å­˜å‚¨åˆ° `raw/`
2. **Chapter å­˜å‚¨**: æ¯ä¸ª chapter çš„ PGN å†…å®¹å­˜å‚¨åˆ° `chapters/`
3. **å¯¼å‡ºåŠŸèƒ½**: å¯¼å‡ºçš„ PGN/ZIP æ–‡ä»¶å­˜å‚¨åˆ° `exports/`
4. **ç‰ˆæœ¬å†å²**: Study ç‰ˆæœ¬å¿«ç…§å­˜å‚¨åˆ° `snapshots/`

### é…é¢å’Œé™åˆ¶
- Cloudflare R2 å…è´¹é¢åº¦: 10GB å­˜å‚¨ + 1M Class A æ“ä½œ/æœˆ
- å¯¹äºå­¦ä¹ å¹³å°ï¼ŒPGN æ–‡ä»¶é€šå¸¸å¾ˆå°ï¼ˆå‡ KBåˆ°å‡ ç™¾KBï¼‰
- é¢„è®¡å¯ä»¥å­˜å‚¨æ•°åƒä¸ª study è€Œä¸è¶…è¿‡å…è´¹é¢åº¦

---

## ä¸‹ä¸€æ­¥å·¥ä½œ

### Phase 4 & 5 ä¿®å¤ä¼˜å…ˆçº§ï¼ˆR2 ç›¸å…³ï¼‰

**Phase 4 (PGN Cleaner) - R2 é›†æˆ**:
- [ ] å®ç° chapter PGN ä¸Šä¼ åˆ° R2
- [ ] å®ç° chapter PGN ä» R2 ä¸‹è½½
- [ ] æµ‹è¯•å¤§æ–‡ä»¶ï¼ˆ100MB+ï¼‰å¯¼å…¥
- [ ] æµ‹è¯• R2 é”™è¯¯å¤„ç†ï¼ˆç½‘ç»œå¤±è´¥ã€æƒé™é—®é¢˜ï¼‰

**Phase 5 (Discussion System) - R2 é›†æˆ**:
- [ ] R2 ä¸ç›´æ¥ç›¸å…³ï¼Œä½†å¯¼å‡ºåŠŸèƒ½ä¼šç”¨åˆ°
- [ ] æœªæ¥ Phase 9 (Export) éœ€è¦ R2 å­˜å‚¨å¯¼å‡ºäº§ç‰©

### å»ºè®®ä¼˜å…ˆçº§
1. **P0**: ä¿®å¤ Phase 4 & 5 çš„æµ‹è¯•å¤±è´¥ï¼ˆé R2 ç›¸å…³ï¼‰
2. **P1**: å®ç° R2 é›†æˆåˆ° PGN import æµç¨‹
3. **P2**: å®ç°å¯¼å‡ºåŠŸèƒ½çš„ R2 å­˜å‚¨
4. **P3**: æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†

---

## æŠ€æœ¯è¯´æ˜

### R2 vs å…¶ä»–å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æˆæœ¬ | å»¶è¿Ÿ | å¸¦å®½ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **R2** | âœ… å…è´¹10GB | âš ï¸ è¾ƒé«˜ | âœ… å…è´¹å‡ºç«™ | PGNæ–‡ä»¶ã€å¯¼å‡ºäº§ç‰© |
| **PostgreSQL** | âš ï¸ å­˜å‚¨æ˜‚è´µ | âœ… ä½ | âœ… å†…ç½‘ | å…ƒæ•°æ®ã€å°æ–‡æœ¬ |
| **Redis** | âš ï¸ å†…å­˜è´µ | âœ… æä½ | âœ… å†…ç½‘ | ç¼“å­˜ã€å®æ—¶æ•°æ® |

**å†³ç­–**: PGN æ–‡ä»¶æ”¾ R2ï¼Œå…ƒæ•°æ®æ”¾ PostgreSQL - è¿™æ˜¯æ­£ç¡®çš„æ¶æ„ï¼

### ä¸ºä»€ä¹ˆä¸ç”¨ S3/OSSï¼Ÿ
- âŒ S3: å‡ºç«™æµé‡æ”¶è´¹æ˜‚è´µï¼ˆ$0.09/GBï¼‰
- âŒ é˜¿é‡Œäº‘ OSS: åŒºåŸŸé™åˆ¶ï¼Œå›½é™…è®¿é—®æ…¢
- âœ… R2: å…è´¹å‡ºç«™æµé‡ï¼Œå…¨çƒ CDN åŠ é€Ÿ

---

## ç›‘æ§å’Œç»´æŠ¤

### å¦‚ä½•æŸ¥çœ‹ R2 ä½¿ç”¨é‡
1. ç™»å½• Cloudflare Dashboard
2. é€‰æ‹© R2 æœåŠ¡
3. æŸ¥çœ‹ `workspace` bucket ç»Ÿè®¡æ•°æ®
   - å­˜å‚¨å¤§å°
   - è¯·æ±‚æ¬¡æ•°
   - å¸¦å®½ä½¿ç”¨

### å‘Šè­¦è®¾ç½®
å»ºè®®è®¾ç½®ä»¥ä¸‹å‘Šè­¦:
- å­˜å‚¨ç©ºé—´æ¥è¿‘ 10GBï¼ˆå…è´¹é¢åº¦ 80%ï¼‰
- æœˆè¯·æ±‚æ•°æ¥è¿‘ 1M æ¬¡ï¼ˆå…è´¹é¢åº¦ 80%ï¼‰
- R2 API é”™è¯¯ç‡è¶…è¿‡ 5%

### å¤‡ä»½ç­–ç•¥
- R2 æœ¬èº«æœ‰é«˜å¯ç”¨æ€§ï¼ˆ11ä¸ª9å¯é æ€§ï¼‰
- ä½†å»ºè®®å®šæœŸå¯¼å‡ºå…³é”®æ•°æ®åˆ°æœ¬åœ°/æ•°æ®åº“
- å…ƒæ•°æ®ï¼ˆstudy/chapter ä¿¡æ¯ï¼‰å¿…é¡»åœ¨ PostgreSQL

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: è¿æ¥å¤±è´¥
```python
# æµ‹è¯•è„šæœ¬
python3 -c "
from storage.r2_client import create_r2_client_from_env
client = create_r2_client_from_env()
print('âœ… Connection OK')
"
```

**å¯èƒ½åŸå› **:
- ç¯å¢ƒå˜é‡æœªè®¾ç½®
- Access Key/Secret é”™è¯¯
- Endpoint URL é”™è¯¯
- ç½‘ç»œé˜²ç«å¢™é˜»æ­¢

### é—®é¢˜ 2: æƒé™è¢«æ‹’ç»
**ç—‡çŠ¶**: `AccessDenied` é”™è¯¯

**æ£€æŸ¥**:
- Token æ˜¯å¦è¿‡æœŸ
- Bucket åç§°æ˜¯å¦æ­£ç¡®
- Token æƒé™èŒƒå›´æ˜¯å¦åŒ…å«è¯¥æ“ä½œ

### é—®é¢˜ 3: å¯¹è±¡ä¸å­˜åœ¨
**ç—‡çŠ¶**: `NoSuchKey` é”™è¯¯

**æ£€æŸ¥**:
- Key å‘½åæ˜¯å¦æ­£ç¡®ï¼ˆå‚è€ƒ `storage/keys.py`ï¼‰
- å¯¹è±¡æ˜¯å¦å·²è¢«åˆ é™¤
- Bucket åç§°æ˜¯å¦æ­£ç¡®

---

## æ€»ç»“

### âœ… å·²å®Œæˆ
1. æœ¬åœ° R2 é…ç½®ï¼ˆ.env æ–‡ä»¶ï¼‰
2. ä»£ç å’Œæ–‡æ¡£ä¿®æ­£ï¼ˆbucket åç§°ç»Ÿä¸€ï¼‰
3. è¿æ¥æµ‹è¯•é€šè¿‡
4. æ–‡æ¡£å®Œå–„

### âš ï¸ å¾…å®Œæˆ
1. **Railway ç¯å¢ƒå˜é‡é…ç½®**ï¼ˆéœ€è¦è€æ¿åœ¨ Railway æ§åˆ¶å°æ“ä½œï¼‰
2. Phase 4 R2 é›†æˆå®ç°ï¼ˆä»£ç å¼€å‘ï¼‰
3. Phase 5 æµ‹è¯•ä¿®å¤ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰

### ğŸ’¡ å»ºè®®
- å…ˆä¿®å¤ Phase 4 & 5 çš„åŸºç¡€æµ‹è¯•å¤±è´¥
- å†å®ç° R2 é›†æˆåŠŸèƒ½
- æœ€ååšæ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§

---

**é…ç½®è´Ÿè´£äºº**: ç›‘å·¥
**å®Œæˆæ—¶é—´**: 2026-01-11 15:30
**ä¸‹æ¬¡æ£€æŸ¥**: Phase 4 å®ç° R2 é›†æˆæ—¶
